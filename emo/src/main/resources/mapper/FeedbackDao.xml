<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dadaepo.emo.dao.FeedbackDao">
    <insert id="insertReaction" parameterType="com.dadaepo.emo.dto.feedback.ReactionRequest"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO feedback(
            member_id
            , memo_id
            , reaction
        )
        VALUES(
            #{sendId}
            , #{memoId}
            , #{reaction}
        )
    </insert>
    <insert id="insertReactionStatus" parameterType="com.dadaepo.emo.dto.feedback.ReactionRequest">
        INSERT INTO reaction_status(
            member_id
            , memo_id
            , reaction_id
        )
        VALUES(
            #{reactionRequest.sendId}
            , #{reactionRequest.memoId}
            , #{reactionId}
        )
    </insert>
    <select id="selectReactions" resultType="com.dadaepo.emo.dto.feedback.ReactionInfo">
        SELECT reaction
        , profile_photo_url AS photoURl
        , name
        , nickname
        FROM feedback
        INNER JOIN member
            ON feedback.member_id = member.id
        WHERE memo_id = #{memoId}
    </select>
    <select id="selectCountReactionByType" resultType="int">
        SELECT COUNT(*)
        FROM feedback
        WHERE memo_id = #{memoId}
        GROUP BY reaction
    </select>
    <select id="selectReactionStatus" resultType="int">
        SELECT IFNULL(status, 0)
        FROM reaction_status
        WHERE memo_id = #{memoId}
            AND member_id = #{sendId}
    </select>
    <update id="updateReaction">
        UPDATE feedback
        SET reaction = #{reaction}
        WHERE memo_id = #{memoId}
            AND member_id = #{sendId}
    </update>
    <update id="updateStatus">
        UPDATE reaction_status
        SET status = if(status=1, 2, 1)
        WHERE memo_id = #{memoId}
            AND member_id = #{sendId}
    </update>
    <delete id="deleteReaction">
        DELETE FROM feedback
        WHERE memo_id = #{memoId}
            AND member_id = #{sendId}
    </delete>
</mapper>
